import React, { useState, useEffect, useMemo } from 'react';
import {
LayoutDashboard,
Package,
History,
DollarSign,
TrendingUp,
Search,
Filter,
Download,
Menu,
ChevronDown,
ChevronRight,
ChevronUp,
AlertTriangle,
Box,
ShoppingCart,
Truck,
Settings,
Image as ImageIcon,
Edit,
X,
Save,
ExternalLink,
CheckCircle,
RefreshCw,
Clock,
ArrowUpRight,
ArrowDownRight,
Wallet,
AlertOctagon,
Plus,
Check,
FileSpreadsheet,
FileText,
FileUp,
FileDown,
Link as LinkIcon,
Unlink,
Power,
Globe,
ShoppingBag,
Store,
Zap,
Bike,
ListFilter,
ArrowUp,
ArrowDown,
ArrowUpDown,
Columns,
Eye,
EyeOff,
GripVertical,
Database,
Printer,
Trash2,
Tag,
FolderInput,
ToggleRight,
MapPin
} from 'lucide-react';

// --- CUSTOM STYLES FOR ANIMATIONS (Replaces tailwindcss-animate plugin dependencies) ---
const CustomStyles = () => (
<style>
    {
        ` @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-slide-in {
            animation: slideInDown 0.2s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideInUp 0.3s ease-out forwards;
        }

        .animate-zoom-in {
            animation: zoomIn 0.15s ease-out forwards;
        }

        /* Scrollbar styling for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        `
    }
</style>
);

// --- DATOS SIMULADOS INICIALES (MOCKS) ---
const INITIAL_PRODUCTS = [
{
id: 'BOLS-001',
name: 'Bolso Playero XL - Arena',
alias: 'Bolso Arena XL',
category: 'Playa',
stock: 12,
committed: 2,
minStock: 15,
ean: '7791234567890',
brand: 'SummerVibes',
model: 'XL-2023',
color: 'Arena',
measures: '40x50x15 cm',
weight: '0.5 kg',
tags: 'Verano, Oferta, Playa',
description: 'Bolso amplio ideal para la playa, con cierre reforzado y tela impermeable.',
lastUpdated: '10/01/2026',
cost: 2500,
price: 4500,
salesLast30: 45,
location: 'A-01',
imgUrl: 'https://images.unsplash.com/photo-1544816155-12df9643f363?auto=format&fit=crop&w=100&q=80',
channels: [
{
id: 'mel',
platform: 'MercadoLibre',
status: 'active',
externalId: 'MLA-1423985',
title: 'Bolso Playero Grande Mujer Verano Cierre',
permalink: '#',
priceOverride: 4500,
bufferStock: 2,
lastSync: 'Hace 5 min',
shippingType: 'full'
},
{
id: 'woo',
platform: 'WooCommerce',
status: 'paused',
externalId: 'WOO-5592',
title: 'Bolso Playero XL - Arena Premium',
permalink: '#',
priceOverride: 4800,
bufferStock: 0,
lastSync: 'Hace 1 hora',
shippingType: 'local'
},
{
id: 'frav',
platform: 'Fravega',
status: 'error',
externalId: 'FRV-999',
title: 'Bolso SummerVibes XL',
permalink: '#',
priceOverride: 4500,
bufferStock: 5,
lastSync: 'Error al sincronizar',
shippingType: 'standard'
}
],
syncStatus: { platform: 'Multi', status: 'Activo', link: '#' },
},
{
id: 'BOT-DEP-05',
name: 'Botella Deportiva 1L - Azul',
alias: 'Botella Azul 1L',
category: 'Deportes',
stock: 150,
committed: 10,
minStock: 20,
ean: '7799876543210',
brand: 'Sporty',
model: 'Hydra-1000',
color: 'Azul Marino',
measures: '25x8x8 cm',
weight: '0.2 kg',
tags: 'Hidratación, Gym, Bici',
description: 'Botella libre de BPA, tapa a rosca anti-derrame.',
syncStatus: { platform: 'Mercado Libre', status: 'Pendiente', link: '#' },
lastUpdated: '05/01/2026',
cost: 1200,
price: 2200,
salesLast30: 8,
location: 'B-04',
imgUrl: 'https://images.unsplash.com/photo-1602143407151-11115cdbf6e0?auto=format&fit=crop&w=100&q=80'
},
{
id: 'LONA-002',
name: 'Lona Estampada Tropical',
alias: '',
category: 'Playa',
stock: 25,
committed: 0,
minStock: 10,
ean: 'Sin EAN',
brand: 'Generic',
model: 'Trop-01',
color: 'Multicolor',
measures: '150x200 cm',
weight: '0.8 kg',
tags: 'Picnic, Exterior',
description: '',
syncStatus: { platform: 'Tienda Nube', status: 'Error', link: '#' },
lastUpdated: '20/12/2025',
cost: 3000,
price: 5500,
salesLast30: 20,
location: 'A-02',
imgUrl: null
},
{
id: 'GOR-010',
name: 'Gorra Visera Plana - Negra',
alias: 'Gorra Negra',
category: 'Accesorios',
stock: 200,
committed: 50,
minStock: 30,
ean: '7791112223334',
brand: 'UrbanCap',
model: 'Flat-V',
color: 'Negro',
measures: 'Adjustable',
weight: '0.1 kg',
tags: 'Moda, Verano',
description: 'Gorra estilo urbano con visera plana y broche ajustable.',
syncStatus: { platform: 'Mercado Libre', status: 'Sincronizado', link: '#' },
cost: 1500,
price: 2800,
salesLast30: 0,
location: 'C-01',
lastUpdated: '15/11/2025',
imgUrl: 'https://images.unsplash.com/photo-1588850561407-ed78c282e89b?auto=format&fit=crop&w=100&q=80'
},
{
id: 'CRM-SOL-50',
name: 'Protector Solar FPS 50',
alias: 'Protector 50',
category: 'Cuidado',
stock: 5,
committed: 0,
minStock: 20,
ean: '7795556667778',
brand: 'SunGuard',
model: 'FPS-50',
color: 'Blanco',
measures: '200ml',
weight: '0.25 kg',
tags: 'Salud, Verano',
description: 'Alta protección contra rayos UVA/UVB.',
syncStatus: { platform: 'Farmacia', status: 'Sincronizado', link: '#' },
cost: 4500,
price: 8000,
salesLast30: 60,
location: 'D-05',
lastUpdated: '08/01/2026',
imgUrl: null
},
];

// --- DEFINICIÓN DE COLUMNAS (CONFIGURACIÓN INICIAL) ---
const DEFAULT_COLUMN_CONFIG = [
// Nueva columna para checkboxes agregada manualmente en la renderización, no en config
{ key: 'img', label: 'Img', visible: true, sortable: false, align: 'center', width: 'w-14' },
{ key: 'name', label: 'Nombre Producto', visible: true, sortable: true, sortKey: 'name' },
{ key: 'sku', label: 'SKU', visible: true, sortable: true, sortKey: 'sku', className: 'hidden md:table-cell' },
{ key: 'ean', label: 'EAN', visible: false, sortable: false },
{ key: 'brand', label: 'Marca', visible: false, sortable: false },
{ key: 'stock', label: 'Stock', visible: true, sortable: true, sortKey: 'stock', align: 'center' },
{ key: 'category', label: 'Categoría', visible: true, sortable: true, sortKey: 'category', className: 'hidden
sm:table-cell' },
{ key: 'status', label: 'Estado', visible: true, sortable: false, align: 'center' },
{ key: 'location', label: 'Depósito', visible: true, sortable: false, align: 'center', className: 'hidden lg:table-cell'
},
{ key: 'actions', label: 'Acciones', visible: true, sortable: false, align: 'center', width: 'w-20' },
];

// --- COMPONENTES AUXILIARES ---

const StatusBadge = ({ stock, min, available }) => {
if (available <= 0) return <span
    className="px-2 py-1 rounded-full text-[10px] font-bold uppercase bg-gray-100 text-gray-500 border border-gray-200">
    Agotado</span>;
    if (available <= min) return <span
        className="px-2 py-1 rounded-full text-[10px] font-bold uppercase bg-red-100 text-red-600 border border-red-200">
        Crítico</span>;
        if (available <= min * 1.5) return <span
            className="px-2 py-1 rounded-full text-[10px] font-bold uppercase bg-yellow-100 text-yellow-700 border border-yellow-200">
            Bajo</span>;
            return <span
                className="px-2 py-1 rounded-full text-[10px] font-bold uppercase bg-green-100 text-green-700 border border-green-200">Activo</span>;
            };

            const Card = ({ title, children, className = "" }) => (
            <div className={`bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden w-full ${className}`}>
                {title && (
                <div className="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex items-center gap-2">
                    <div className="h-4 w-1 bg-blue-600 rounded-full"></div>
                    <h3 className="text-sm font-bold uppercase tracking-wide text-gray-700">{title}</h3>
                </div>
                )}
                <div className="px-6 py-4">
                    {children}
                </div>
            </div>
            );

            const DataRow = ({ label, children, isLast = false }) => (
            <div className={`flex flex-col sm:flex-row sm:items-center py-3 ${!isLast ? 'border-b border-gray-100' : ''
                }`}>
                <div className="w-full sm:w-48 flex-shrink-0 mb-2 sm:mb-0">
                    <span className="text-sm font-bold text-gray-700">{label}</span>
                </div>
                <div className="flex-1 text-sm font-medium text-gray-900 w-full">
                    {children}
                </div>
            </div>
            );

            // --- COMPONENTE DE TARJETA DE SINCRONIZACIÓN ---
            const SyncChannelCard = ({ channel, generalPrice }) => {
            const [expanded, setExpanded] = useState(false);
            const [localChannel, setLocalChannel] = useState(channel);

            const getPlatformConfig = (platform) => {
            switch (platform) {
            case 'MercadoLibre': return { icon: ShoppingBag, color: 'text-yellow-600', bg: 'bg-yellow-50' };
            case 'WooCommerce': return { icon: Globe, color: 'text-purple-600', bg: 'bg-purple-50' };
            case 'Fravega': return { icon: Store, color: 'text-indigo-600', bg: 'bg-indigo-50' };
            default: return { icon: LinkIcon, color: 'text-gray-600', bg: 'bg-gray-50' };
            }
            };

            const getStatusConfig = (status) => {
            switch (status) {
            case 'active': return { label: 'Activa', color: 'bg-green-100 text-green-700 border-green-200', border:
            'border-l-green-500' };
            case 'paused': return { label: 'Pausada', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', border:
            'border-l-yellow-500' };
            case 'closed': return { label: 'Finalizada', color: 'bg-red-100 text-red-700 border-red-200', border:
            'border-l-red-500' };
            case 'error': return { label: 'Error Sync', color: 'bg-orange-100 text-orange-700 border-orange-200',
            border: 'border-l-orange-500' };
            default: return { label: 'Desc.', color: 'bg-gray-100 text-gray-700', border: 'border-l-gray-300' };
            }
            };

            const ShippingBadge = ({ type }) => {
            if (!type) return null;
            switch (type) {
            case 'full':
            return <span
                className="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 flex items-center gap-1 border border-green-200">
                <Zap size={10} fill="currentColor" /> FULL
            </span>;
            case 'flex':
            return <span
                className="px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-700 flex items-center gap-1 border border-yellow-200">
                <Bike size={10} /> FLEX
            </span>;
            case 'me2':
            return <span
                className="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-700 flex items-center gap-1 border border-blue-200">
                <Truck size={10} /> ENVÍOS
            </span>;
            default:
            return <span
                className="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-600 flex items-center gap-1 border border-gray-200">
                <Truck size={10} /> {type.toUpperCase()}
            </span>;
            }
            };

            const config = getPlatformConfig(localChannel.platform);
            const statusConfig = getStatusConfig(localChannel.status);
            const PlatformIcon = config.icon;

            const handleTogglePause = (e) => {
            e.stopPropagation();
            setLocalChannel(prev => ({
            ...prev,
            status: prev.status === 'active' ? 'paused' : 'active'
            }));
            };

            return (
            <div className={`bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden mb-4 transition-all
                ${statusConfig.border} border-l-4`}>
                <div className="px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors"
                    onClick={()=> setExpanded(!expanded)}
                    >
                    <div className="flex items-center gap-3">
                        <div className={`p-2 rounded-lg ${config.bg}`}>
                            <PlatformIcon size={20} className={config.color} />
                        </div>
                        <div>
                            <h4 className="font-bold text-gray-800 text-sm">{localChannel.platform}</h4>
                            <div className="flex items-center gap-2 mt-0.5">
                                <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold uppercase border
                                    ${statusConfig.color} flex items-center gap-1`}>
                                    {localChannel.status === 'active' && <span
                                        className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>}
                                    {statusConfig.label}
                                </span>
                                <span
                                    className="text-xs text-gray-400 font-mono hidden sm:inline cursor-text select-text hover:text-gray-600"
                                    onClick={(e)=> e.stopPropagation()}
                                    title="Copiar ID"
                                    >
                                    {localChannel.externalId}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div className="flex items-center gap-2">
                        <a href={localChannel.permalink} target="_blank" rel="noopener noreferrer"
                            className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="Ver publicación real" onClick={(e)=> e.stopPropagation()}
                            >
                            <ExternalLink size={16} />
                        </a>
                        {expanded ?
                        <ChevronUp size={18} className="text-gray-400" /> :
                        <ChevronDown size={18} className="text-gray-400" />}
                    </div>
                </div>

                {expanded && (
                <div className="border-t border-gray-100 bg-gray-50/50 p-4 animate-slide-in">
                    <div className="mb-4">
                        <div className="flex justify-between items-center mb-1">
                            <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Título en
                                {localChannel.platform}</label>
                            <ShippingBadge type={localChannel.shippingType} />
                        </div>
                        <input type="text" defaultValue={localChannel.title}
                            className="w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                    </div>

                    <div className="bg-white rounded-lg border border-gray-200 p-4 mb-4 shadow-sm">
                        <div className="flex items-center gap-2 mb-3">
                            <Settings size={14} className="text-blue-600" />
                            <span className="text-sm font-bold text-gray-800">Datos Diferenciales</span>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">Precio en
                                    Plataforma</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                                    <input type="text" value={localChannel.priceOverride || generalPrice} disabled
                                        className="w-full pl-6 pr-3 py-1.5 text-sm border border-gray-200 bg-gray-50 text-gray-600 rounded-md font-bold cursor-not-allowed"
                                        title="El precio se gestiona desde la lista de precios o actualización masiva" />
                                </div>
                                <p className="text-[10px] text-gray-400 mt-1">Precio actual visible en la web</p>
                            </div>

                            <div>
                                <label className="text-xs font-medium text-gray-600 mb-1 block"
                                    title="Cantidad a restar del stock real para evitar sobreventa">Stock de Seguridad
                                    (Buffer)</label>
                                <div className="flex items-center gap-2">
                                    <input type="number" defaultValue={localChannel.bufferStock}
                                        className="w-full py-1.5 text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                                    <span className="text-xs text-gray-400">unid.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex flex-wrap items-center justify-between gap-3 pt-2 border-t border-gray-200">
                        <div className="flex items-center gap-1 text-xs text-gray-400">
                            <Clock size={12} />
                            <span>Sync: {localChannel.lastSync}</span>
                        </div>

                        <div className="flex items-center gap-2">
                            <button
                                className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors group"
                                title="Desvincular Publicación">
                                <Unlink size={16} />
                            </button>

                            <button onClick={handleTogglePause} className={`flex items-center gap-2 px-3 py-1.5
                                rounded-lg text-xs font-bold border transition-colors ${ localChannel.status==='active'
                                ? 'border-yellow-200 text-yellow-700 bg-yellow-50 hover:bg-yellow-100'
                                : 'border-green-200 text-green-700 bg-green-50 hover:bg-green-100' }`}>
                                <Power size={14} />
                                {localChannel.status === 'active' ? 'Pausar' : 'Activar'}
                            </button>

                            <button
                                className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 shadow-sm transition-colors">
                                <RefreshCw size={14} /> Forzar Sync
                            </button>
                        </div>
                    </div>

                </div>
                )}
            </div>
            );
            };

            // --- COMPONENTE MODAL DE PRODUCTO ---
            const ProductModal = ({ product, onClose, onUpdate, categories, onAddCategory }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState({ ...product });

            const [isAddingCategory, setIsAddingCategory] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState("");

            if (!product) return null;

            const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({
            ...prev,
            [name]: value
            }));
            };

            const handleSave = () => {
            // MODIFICADO: Ahora pasamos el ID original (product.id) como primer argumento
            // y el objeto con los datos nuevos (que pueden incluir un nuevo ID) como segundo.
            onUpdate(product.id, {
            ...formData,
            stock: parseInt(formData.stock) || 0,
            lastUpdated: new Date().toLocaleDateString('es-AR')
            });
            setIsEditing(false);
            };

            const handleSaveNewCategory = () => {
            if (newCategoryName.trim()) {
            const newCat = newCategoryName.trim();
            onAddCategory(newCat);
            setFormData(prev => ({ ...prev, category: newCat }));
            setIsAddingCategory(false);
            setNewCategoryName("");
            }
            };

            const readClass = "bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-gray-900 text-sm font-medium
            w-full focus:ring-0 block transition-colors";
            const editClass = "bg-white border border-blue-400 rounded-lg px-3 py-2 text-gray-900 text-sm font-medium
            w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm block transition-all";
            const textAreaReadClass = "bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-gray-900 text-sm
            font-medium w-full resize-none focus:ring-0 leading-relaxed block";

            const getInputClass = () => isEditing ? editClass : readClass;

            return (
            <div
                className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div
                    className="bg-gray-100 rounded-xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden animate-zoom-in">

                    <div
                        className="px-8 py-5 border-b border-gray-200 bg-white flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900 leading-tight">{isEditing ? 'Editar
                                    Producto' : formData.name}</h3>
                                {!isEditing && <span className="text-sm text-gray-500 font-mono">ID:
                                    {product.id}</span>}
                            </div>
                            {isEditing && (
                            <span
                                className="px-3 py-1 bg-blue-100 text-blue-700 text-xs rounded-full uppercase font-bold tracking-wider animate-pulse ml-4">Modo
                                Edición</span>
                            )}
                        </div>

                        <div className="flex gap-3 items-center">
                            {!isEditing ? (
                            <>
                                <div
                                    className="hidden sm:flex items-center gap-1.5 text-gray-400 mr-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">
                                    <Clock size={14} />
                                    <span className="text-xs font-medium">Editado: {product.lastUpdated}</span>
                                </div>

                                <button onClick={()=> setIsEditing(true)}
                                    className="flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-300
                                    text-gray-700 text-sm font-bold rounded-lg hover:bg-gray-50 hover:text-blue-600
                                    transition-colors shadow-sm"
                                    >
                                    <Edit size={18} /> <span className="hidden sm:inline">Editar</span>
                                </button>
                            </>
                            ) : (
                            <div className="flex gap-3">
                                <button onClick={()=> { setIsEditing(false); setFormData({...product});
                                    setIsAddingCategory(false); }}
                                    className="px-5 py-2.5 bg-white border border-gray-300 rounded-lg text-sm
                                    text-gray-700 hover:bg-gray-50 font-bold"
                                    >
                                    Cancelar
                                </button>
                                <button onClick={handleSave}
                                    className="px-5 py-2.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 font-bold flex items-center gap-2 shadow-md">
                                    <Save size={18} /> Guardar
                                </button>
                            </div>
                            )}
                            <div className="h-8 w-px bg-gray-200 mx-2"></div>
                            <button onClick={onClose}
                                className="p-2 text-red-500 hover:bg-red-50 rounded-full transition-colors flex items-center justify-center"
                                title="Cerrar">
                                <X size={28} />
                            </button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-8 bg-gray-50">
                        <div className="flex flex-col space-y-8 max-w-4xl mx-auto">

                            <Card title="Información del Producto">
                                <DataRow label="Nombre">
                                    <input name="name" type="text" value={formData.name} onChange={handleChange}
                                        className={getInputClass()} readOnly={!isEditing} />
                                </DataRow>

                                <DataRow label="SKU">
                                    {/* MODIFICADO: Habilitado para edición */}
                                    <input name="id" type="text" value={formData.id} onChange={handleChange}
                                        className={`${isEditing ? editClass : `${readClass} bg-gray-100 text-gray-500`}
                                        font-mono`} disabled={!isEditing} readOnly={!isEditing} />
                                    {isEditing && <p
                                        className="text-[10px] text-orange-500 mt-1 flex items-center gap-1">
                                        <AlertTriangle size={10} /> Precaución: Cambiar el SKU puede afectar historial.
                                    </p>}
                                </DataRow>

                                <DataRow label="Alias">
                                    <input name="alias" type="text" value={formData.alias} onChange={handleChange}
                                        placeholder="-" className={getInputClass()} readOnly={!isEditing} />
                                </DataRow>

                                <DataRow label="EAN">
                                    <input name="ean" type="text" value={formData.ean} onChange={handleChange}
                                        placeholder="-" className={getInputClass()} readOnly={!isEditing} />
                                </DataRow>

                                <DataRow label="Categoría">
                                    {isEditing ? (
                                    <div className="flex gap-2 w-full items-center">
                                        {!isAddingCategory ? (
                                        <>
                                            <select name="category" value={formData.category} onChange={handleChange}
                                                className={editClass}>
                                                {categories && categories.map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                            <button onClick={()=> setIsAddingCategory(true)}
                                                className="p-2.5 bg-blue-50 text-blue-600 rounded-lg border
                                                border-blue-200 hover:bg-blue-100 hover:border-blue-300 transition-all
                                                shadow-sm"
                                                title="Crear nueva categoría"
                                                >
                                                <Plus size={18} />
                                            </button>
                                        </>
                                        ) : (
                                        <>
                                            <input type="text" value={newCategoryName} onChange={(e)=>
                                            setNewCategoryName(e.target.value)}
                                            placeholder="Nombre nueva categoría..."
                                            className={editClass}
                                            autoFocus
                                            />
                                            <button onClick={handleSaveNewCategory}
                                                className="p-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-sm"
                                                title="Confirmar">
                                                <Check size={18} />
                                            </button>
                                            <button onClick={()=> { setIsAddingCategory(false); setNewCategoryName("");
                                                }}
                                                className="p-2.5 bg-gray-100 text-gray-500 rounded-lg border
                                                border-gray-200 hover:bg-gray-200 hover:text-red-500"
                                                title="Cancelar"
                                                >
                                                <X size={18} />
                                            </button>
                                        </>
                                        )}
                                    </div>
                                    ) : (
                                    <div className={readClass}>
                                        {formData.category}
                                    </div>
                                    )}
                                </DataRow>

                                <DataRow label="Stock" isLast>
                                    <div className="flex items-center gap-3">
                                        <input name="stock" type="number" value={formData.stock} onChange={handleChange}
                                            className={`${getInputClass()} font-bold ${!isEditing ? 'text-blue-700' : ''
                                            } w-32`} readOnly={!isEditing} />
                                        {!isEditing && <span
                                            className="text-xs font-medium text-gray-500 uppercase tracking-wide">unidades
                                            disponibles</span>}
                                    </div>
                                </DataRow>
                            </Card>

                            <Card title="Información de Atributos">
                                <div className="py-6 border-b border-gray-100">
                                    <span className="block text-sm font-bold text-gray-700 mb-4">Imágenes</span>
                                    <div className="flex gap-4 overflow-x-auto">
                                        <div
                                            className="w-32 h-32 flex-shrink-0 bg-white rounded-xl border border-gray-200 shadow-sm flex items-center justify-center relative group overflow-hidden">
                                            {product.imgUrl ? <img src={product.imgUrl}
                                                className="w-full h-full object-cover" alt="" /> :
                                            <ImageIcon className="text-gray-300" size={32} />}
                                        </div>
                                        {[1, 2].map(i => (
                                        <div key={i} className={`w-32 h-32 flex-shrink-0 rounded-xl border-2
                                            border-dashed flex items-center justify-center bg-gray-50/50 ${isEditing
                                            ? 'border-gray-300 hover:border-blue-400 cursor-pointer hover:bg-white'
                                            : 'border-gray-200' }`}>
                                            {isEditing ? <span className="text-gray-400 text-2xl font-light">+</span> :
                                            <ImageIcon className="text-gray-200" size={24} />}
                                        </div>
                                        ))}
                                    </div>
                                </div>

                                <DataRow label="Descripción">
                                    <textarea name="description" rows={3} value={formData.description}
                                        onChange={handleChange} className={isEditing ? editClass : textAreaReadClass}
                                        readOnly={!isEditing} placeholder="Sin descripción..."></textarea>
                                </DataRow>

                                <DataRow label="Marca">
                                    <input name="brand" type="text" value={formData.brand} onChange={handleChange}
                                        placeholder="-" className={getInputClass()} readOnly={!isEditing} />
                                </DataRow>

                                <DataRow label="Etiquetas" isLast>
                                    <input name="tags" type="text" value={formData.tags} onChange={handleChange}
                                        placeholder="Ej: Verano, Oferta" className={getInputClass()}
                                        readOnly={!isEditing} />
                                </DataRow>
                            </Card>

                            <Card title="Sincronización Multicanal">
                                {product.channels ? (
                                <div className="py-2">
                                    {product.channels.map(channel => (
                                    <SyncChannelCard key={channel.id} channel={channel} generalPrice={formData.price} />
                                    ))}

                                    {isEditing && (
                                    <button
                                        className="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition-colors flex items-center justify-center gap-2 text-sm font-bold">
                                        <Plus size={16} /> Vincular nuevo canal
                                    </button>
                                    )}
                                </div>
                                ) : (
                                <DataRow label="Estado" isLast>
                                    <div className={`flex items-center gap-2 ${readClass} !bg-transparent !border-0`}>
                                        {product.syncStatus.status === 'Sincronizado' ? (
                                        <div
                                            className="flex items-center gap-2 text-green-700 bg-green-50 px-3 py-1 rounded-lg border border-green-100">
                                            <CheckCircle size={16} />
                                            <span>Sincronizado con {product.syncStatus.platform}</span>
                                        </div>
                                        ) : (
                                        <div
                                            className="flex items-center gap-2 text-yellow-700 bg-yellow-50 px-3 py-1 rounded-lg border border-yellow-100">
                                            <AlertTriangle size={16} />
                                            <span>{product.syncStatus.status} - {product.syncStatus.platform}</span>
                                        </div>
                                        )}
                                    </div>
                                </DataRow>
                                )}
                            </Card>

                        </div>
                    </div>
                </div>
            </div>
            );
            };

            // --- VISTAS DEL SISTEMA ---

            // 1. DASHBOARD VIEW
            const DashboardView = ({ products }) => {
            const stats = useMemo(() => {
            const totalStock = products.reduce((acc, p) => acc + p.stock, 0);
            const totalValue = products.reduce((acc, p) => acc + (p.stock * p.cost), 0);
            const lowStock = products.filter(p => p.stock <= p.minStock).length; const
                activeProducts=products.filter(p=> p.stock > 0).length;

                return { totalStock, totalValue, lowStock, activeProducts };
                }, [products]);

                const StatCard = ({ title, value, subtext, icon: Icon, color, trend }) => (
                <div
                    className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between h-32">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-sm font-medium text-gray-500 mb-1">{title}</p>
                            <h3 className="text-2xl font-bold text-gray-900">{value}</h3>
                        </div>
                        <div className={`p-2 rounded-lg ${color}`}>
                            <Icon size={20} />
                        </div>
                    </div>
                    <div className="flex items-center text-xs">
                        <span className={`font-bold flex items-center ${trend==='up' ? 'text-green-600' : 'text-red-600'
                            }`}>
                            {trend === 'up' ?
                            <ArrowUpRight size={14} className="mr-1" /> :
                            <ArrowDownRight size={14} className="mr-1" />}
                            {subtext}
                        </span>
                        <span className="text-gray-400 ml-1">vs mes pasado</span>
                    </div>
                </div>
                );

                return (
                <div className="space-y-6 animate-fade-in">
                    <h2 className="text-2xl font-bold text-gray-800">Tablero Principal</h2>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Valor de Inventario" value={`$${stats.totalValue.toLocaleString()}`}
                            subtext="+12%" icon={Wallet} color="bg-blue-50 text-blue-600" trend="up" />
                        <StatCard title="Total Unidades" value={stats.totalStock} subtext="+5%" icon={Box}
                            color="bg-purple-50 text-purple-600" trend="up" />
                        <StatCard title="Productos Activos" value={stats.activeProducts} subtext="-2" icon={Package}
                            color="bg-green-50 text-green-600" trend="down" />
                        <StatCard title="Stock Crítico" value={stats.lowStock} subtext={stats.lowStock> 0 ? "Acción
                            requerida" : "Todo bien"}
                            icon={AlertOctagon}
                            color="bg-red-50 text-red-600"
                            trend={stats.lowStock > 0 ? "down" : "up"}
                            />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-gray-800">Top Productos (Valorizados)</h3>
                                <button className="text-sm text-blue-600 hover:underline">Ver reporte</button>
                            </div>
                            <div className="space-y-4">
                                {products.slice(0, 4).map((p, idx) => (
                                <div key={idx}
                                    className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div
                                            className="w-8 h-8 rounded bg-gray-100 flex items-center justify-center font-bold text-gray-500 text-xs">
                                            #{idx+1}</div>
                                        <div>
                                            <p className="font-medium text-gray-900 text-sm">{p.name}</p>
                                            <p className="text-xs text-gray-500">{p.stock} unidades</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-gray-900 text-sm">${(p.stock *
                                            p.cost).toLocaleString()}</p>
                                    </div>
                                </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 className="font-bold text-gray-800 mb-6">Estado de Almacén</h3>
                            <div className="relative pt-4">
                                <div className="flex justify-between text-sm mb-2">
                                    <span className="text-gray-600">Ocupación (A-01)</span>
                                    <span className="font-bold text-gray-900">85%</span>
                                </div>
                                <div className="w-full bg-gray-100 rounded-full h-2.5 mb-6">
                                    <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: '85%' }}></div>
                                </div>

                                <div className="flex justify-between text-sm mb-2">
                                    <span className="text-gray-600">Ocupación (B-04)</span>
                                    <span className="font-bold text-gray-900">42%</span>
                                </div>
                                <div className="w-full bg-gray-100 rounded-full h-2.5 mb-6">
                                    <div className="bg-green-500 h-2.5 rounded-full" style={{ width: '42%' }}></div>
                                </div>

                                <div className="mt-8 p-4 bg-yellow-50 rounded-lg border border-yellow-100">
                                    <div className="flex gap-2 text-yellow-800 font-bold text-sm items-center mb-1">
                                        <AlertTriangle size={16} /> Atención
                                    </div>
                                    <p className="text-xs text-yellow-700">El depósito C-01 está alcanzando su capacidad
                                        máxima. Se recomienda revisión.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                );
                };

                // 2. VALUATION VIEW
                const ValuationView = ({ products }) => (
                <div className="h-full flex flex-col space-y-4 animate-fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800">Valorización de Inventario</h2>
                        <div className="text-sm bg-white border px-3 py-1 rounded-lg">Total Items:
                            <strong>{products.length}</strong>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 flex-1 overflow-hidden">
                        <div className="overflow-auto h-full">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-50 text-xs text-gray-500 uppercase sticky top-0 z-10">
                                    <tr>
                                        <th className="px-4 py-3">Producto</th>
                                        <th className="px-4 py-3 text-right">Costo Unit.</th>
                                        <th className="px-4 py-3 text-right">Precio Venta</th>
                                        <th className="px-4 py-3 text-center">Margen</th>
                                        <th className="px-4 py-3 text-center">Stock</th>
                                        <th className="px-4 py-3 text-right">Valor Total (Costo)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100 text-sm">
                                    {products.map(p => {
                                    const margin = p.price - p.cost;
                                    const marginPercent = ((margin / p.cost) * 100).toFixed(1);
                                    const totalVal = p.cost * p.stock;
                                    return (
                                    <tr key={p.id} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 font-medium text-gray-900">{p.name}</td>
                                        <td className="px-4 py-3 text-right text-gray-600">${p.cost}</td>
                                        <td className="px-4 py-3 text-right text-gray-600">${p.price}</td>
                                        <td className="px-4 py-3 text-center">
                                            <span
                                                className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">{marginPercent}%</span>
                                        </td>
                                        <td className="px-4 py-3 text-center font-mono">{p.stock}</td>
                                        <td className="px-4 py-3 text-right font-bold text-gray-900">
                                            ${totalVal.toLocaleString()}</td>
                                    </tr>
                                    );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                );

                // 3. HISTORY VIEW
                const HistoryView = () => {
                const movements = [
                { id: 1, date: '12/01/2026 10:30', type: 'Ingreso', prod: 'Bolso Playero XL', qty: 10, user: 'Admin' },
                { id: 2, date: '12/01/2026 11:15', type: 'Venta', prod: 'Botella Deportiva', qty: -2, user: 'Sistema' },
                { id: 3, date: '11/01/2026 09:00', type: 'Ajuste', prod: 'Gorra Visera', qty: -1, user: 'J.Doe' },
                { id: 4, date: '10/01/2026 16:45', type: 'Ingreso', prod: 'Protector Solar', qty: 50, user: 'Admin' },
                ];

                return (
                <div className="space-y-6 animate-fade-in">
                    <h2 className="text-2xl font-bold text-gray-800">Historial de Movimientos</h2>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 text-xs text-gray-500 uppercase">
                                <tr>
                                    <th className="px-6 py-3">Fecha</th>
                                    <th className="px-6 py-3">Tipo</th>
                                    <th className="px-6 py-3">Producto</th>
                                    <th className="px-6 py-3 text-right">Cantidad</th>
                                    <th className="px-6 py-3">Usuario</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 text-sm">
                                {movements.map(m => (
                                <tr key={m.id} className="hover:bg-gray-50">
                                    <td className="px-6 py-3 text-gray-500">{m.date}</td>
                                    <td className="px-6 py-3">
                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${m.type==='Ingreso'
                                            ? 'bg-green-100 text-green-700' : m.type==='Venta'
                                            ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700' }`}>
                                            {m.type}
                                        </span>
                                    </td>
                                    <td className="px-6 py-3 font-medium">{m.prod}</td>
                                    <td className={`px-6 py-3 text-right font-bold ${m.qty> 0 ? 'text-green-600' :
                                        'text-red-600'}`}>{m.qty > 0 ? `+${m.qty}` : m.qty}</td>
                                    <td className="px-6 py-3 text-gray-500">{m.user}</td>
                                </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
                )
                };

                const RotationView = () => <div className="flex items-center justify-center h-full text-gray-400">Vista
                    de Rotación (En desarrollo)</div>;

                // VISTA PRINCIPAL: CONTROL DE STOCK
                const StockControlView = ({ products, onUpdateProduct, categories, onAddCategory }) => {
                const [search, setSearch] = useState('');
                const [selectedProduct, setSelectedProduct] = useState(null);
                const [showExportMenu, setShowExportMenu] = useState(false);
                const [showFilterMenu, setShowFilterMenu] = useState(false);

                // NUEVO: Estado para configuración de columnas
                const [columns, setColumns] = useState(DEFAULT_COLUMN_CONFIG);
                const [showColumnMenu, setShowColumnMenu] = useState(false);

                // Estados para Drag & Drop
                const [dragItemIndex, setDragItemIndex] = useState(null);

                // NUEVO: Estado para selección múltiple
                const [selectedItems, setSelectedItems] = useState(new Set());

                const [activeFilters, setActiveFilters] = useState({
                category: '',
                status: '',
                linked: '',
                warehouse: '',
                sort: 'az'
                });

                const toggleColumn = (key) => {
                setColumns(prev => prev.map(col =>
                col.key === key ? { ...col, visible: !col.visible } : col
                ));
                };

                // --- Handlers para Drag & Drop ---
                const handleDragStart = (e, position) => {
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData('text/plain', position);
                setDragItemIndex(position);
                };

                const handleDragOver = (e) => {
                e.preventDefault();
                };

                const handleDrop = (e, targetPosition) => {
                e.preventDefault();
                const sourcePosition = parseInt(e.dataTransfer.getData('text/plain'));

                if (sourcePosition === targetPosition || isNaN(sourcePosition)) return;

                const newColumns = [...columns];
                const [movedItem] = newColumns.splice(sourcePosition, 1);
                newColumns.splice(targetPosition, 0, movedItem);

                setColumns(newColumns);
                setDragItemIndex(null);
                };

                // --- NUEVO: Handlers para Selección Múltiple ---
                const toggleSelectAll = (filteredProducts) => {
                if (selectedItems.size === filteredProducts.length) {
                setSelectedItems(new Set()); // Deseleccionar todo
                } else {
                const allIds = new Set(filteredProducts.map(p => p.id));
                setSelectedItems(allIds);
                }
                };

                const toggleSelectItem = (id) => {
                const newSelected = new Set(selectedItems);
                if (newSelected.has(id)) {
                newSelected.delete(id);
                } else {
                newSelected.add(id);
                }
                setSelectedItems(newSelected);
                };

                // Helper para renderizar celdas dinámicamente
                const renderCell = (col, product) => {
                const available = product.stock - product.committed;

                switch(col.key) {
                case 'img':
                return (
                <div
                    className="h-10 w-10 rounded-lg bg-gray-100 border border-gray-200 flex items-center justify-center overflow-hidden mx-auto">
                    {product.imgUrl ? (
                    <img src={product.imgUrl} alt="" className="h-full w-full object-cover" />
                    ) : (
                    <ImageIcon size={18} className="text-gray-400" />
                    )}
                </div>
                );
                case 'name':
                return (
                <>
                    <div className="font-medium text-gray-900 truncate max-w-[150px] sm:max-w-[200px]"
                        title={product.name}>
                        {product.name}
                    </div>
                    <div className="md:hidden text-xs text-gray-500 font-mono mt-1">{product.id}</div>
                </>
                );
                case 'sku':
                return (
                <span
                    className="font-mono text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">
                    {product.id}
                </span>
                );
                case 'ean':
                return <span className="text-gray-500 font-mono text-xs">{product.ean || '-'}</span>;
                case 'brand':
                return <span className="text-gray-700 font-medium">{product.brand || '-'}</span>;
                case 'stock':
                return (
                <div className="flex flex-col items-center">
                    <span className={`font-bold text-sm ${available < product.minStock ? 'text-red-600'
                        : 'text-gray-800' }`}>
                        {available} u.
                    </span>
                    <span className="text-[10px] text-gray-400 whitespace-nowrap">
                        Físico: {product.stock}
                    </span>
                </div>
                );
                case 'category':
                return product.category;
                case 'status':
                return
                <StatusBadge stock={product.stock} min={product.minStock} available={available} />;
                case 'location':
                return (
                <div className="flex items-center justify-center gap-1 text-gray-600">
                    <Truck size={14} className="text-gray-400" />
                    <span>{product.location}</span>
                </div>
                );
                case 'actions':
                return (
                <button onClick={()=> setSelectedProduct(product)}
                    className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex items-center
                    justify-center mx-auto"
                    title="Ver Ficha Completa"
                    >
                    <Edit size={18} />
                </button>
                );
                default:
                return null;
                }
                };

                const uniqueLocations = useMemo(() => [...new Set(products.map(p => p.location))], [products]);

                const filtered = products.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(search.toLowerCase()) ||
                p.id.toLowerCase().includes(search.toLowerCase());

                const matchesCategory = activeFilters.category ? p.category === activeFilters.category : true;

                let matchesStatus = true;
                const available = p.stock - p.committed;
                if (activeFilters.status === 'out_of_stock') matchesStatus = available <= 0; if
                    (activeFilters.status==='low_stock' ) matchesStatus=available <=p.minStock && available> 0;
                    if (activeFilters.status === 'active') matchesStatus = available > p.minStock;

                    let matchesLinked = true;
                    const isLinked = p.channels && p.channels.length > 0;
                    if (activeFilters.linked === 'yes') matchesLinked = isLinked;
                    if (activeFilters.linked === 'no') matchesLinked = !isLinked;

                    const matchesWarehouse = activeFilters.warehouse ? p.location === activeFilters.warehouse : true;

                    return matchesSearch && matchesCategory && matchesStatus && matchesLinked && matchesWarehouse;
                    }).sort((a, b) => {
                    switch (activeFilters.sort) {
                    case 'az': return a.name.localeCompare(b.name);
                    case 'za': return b.name.localeCompare(a.name);
                    case 'sku_asc': return a.id.localeCompare(b.id, undefined, { numeric: true });
                    case 'sku_desc': return b.id.localeCompare(a.id, undefined, { numeric: true });
                    case 'cat_asc': return a.category.localeCompare(b.category);
                    case 'cat_desc': return b.category.localeCompare(a.category);
                    case 'stock_asc': return (a.stock - a.committed) - (b.stock - b.committed);
                    case 'stock_desc': return (b.stock - b.committed) - (a.stock - a.committed);
                    case 'price_asc': return a.price - b.price;
                    case 'price_desc': return b.price - a.price;
                    case 'newest': {
                    const dateA = new Date(a.lastUpdated.split('/').reverse().join('-'));
                    const dateB = new Date(b.lastUpdated.split('/').reverse().join('-'));
                    return dateB - dateA;
                    }
                    case 'oldest': {
                    const dateA = new Date(a.lastUpdated.split('/').reverse().join('-'));
                    const dateB = new Date(b.lastUpdated.split('/').reverse().join('-'));
                    return dateA - dateB;
                    }
                    default: return 0;
                    }
                    });

                    const handleFilterChange = (key, value) => {
                    setActiveFilters(prev => ({ ...prev, [key]: value }));
                    };

                    const handleSort = (key) => {
                    let newSort = '';
                    if (key === 'name') newSort = activeFilters.sort === 'az' ? 'za' : 'az';
                    else if (key === 'sku') newSort = activeFilters.sort === 'sku_asc' ? 'sku_desc' : 'sku_asc';
                    else if (key === 'category') newSort = activeFilters.sort === 'cat_asc' ? 'cat_desc' : 'cat_asc';
                    else if (key === 'stock') newSort = activeFilters.sort === 'stock_desc' ? 'stock_asc' :
                    'stock_desc';
                    handleFilterChange('sort', newSort);
                    };

                    const SortableHeader = ({ label, sortKey, currentSort, onSort, className = "", children }) => {
                    let isActive = false;
                    let direction = null;

                    if (sortKey === 'name') {
                    isActive = currentSort === 'az' || currentSort === 'za';
                    if (isActive) direction = currentSort === 'az' ? 'asc' : 'desc';
                    } else if (sortKey === 'sku') {
                    isActive = currentSort === 'sku_asc' || currentSort === 'sku_desc';
                    if (isActive) direction = currentSort === 'sku_asc' ? 'asc' : 'desc';
                    } else if (sortKey === 'category') {
                    isActive = currentSort === 'cat_asc' || currentSort === 'cat_desc';
                    if (isActive) direction = currentSort === 'cat_asc' ? 'asc' : 'desc';
                    } else if (sortKey === 'stock') {
                    isActive = currentSort === 'stock_asc' || currentSort === 'stock_desc';
                    if (isActive) direction = currentSort === 'stock_asc' ? 'asc' : 'desc';
                    }

                    return (
                    <th className={`px-3 py-4 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors group
                        select-none ${className}`} onClick={()=> onSort(sortKey)}
                        >
                        <div className={`flex items-center gap-1 ${isActive ? 'text-blue-700 font-bold'
                            : 'text-gray-500' } ${className.includes('text-center') ? 'justify-center' : '' }`}>
                            {label}
                            <div className="flex flex-col">
                                {isActive ? (
                                direction === 'asc' ?
                                <ArrowUp size={14} strokeWidth={2.5} /> :
                                <ArrowDown size={14} strokeWidth={2.5} />
                                ) : (
                                <ArrowUpDown size={14} className="text-gray-300 group-hover:text-gray-400" />
                                )}
                            </div>
                        </div>
                    </th>
                    );
                    };

                    const clearFilters = () => {
                    setActiveFilters({ category: '', status: '', linked: '', warehouse: '', sort: 'az' });
                    setSearch('');
                    };

                    const activeFilterCount = Object.entries(activeFilters)
                    .filter(([key, value]) => key !== 'sort' && Boolean(value))
                    .length;

                    // Renderizado del Header de Tabla (Variable)
                    const renderTableHeader = () => {
                    if (selectedItems.size > 0) {
                    // --- HEADER DE ACCIONES MASIVAS ---
                    return (
                    <div
                        className="flex items-center justify-between px-6 py-3 bg-blue-50 border-b border-blue-100 animate-fade-in sticky top-0 z-20">
                        <div className="flex items-center gap-4">
                            <span className="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-md">
                                {selectedItems.size} seleccionados
                            </span>
                            <div className="h-4 w-px bg-blue-200"></div>

                            <div className="flex gap-1">
                                {/* MODIFICADO: Enfocado en Inventario/Sync/Estado */}
                                <button
                                    className="p-2 text-blue-700 hover:bg-blue-100 rounded-lg transition-colors flex items-center gap-2"
                                    title="Pausar/Activar Publicaciones">
                                    <Power size={18} /> <span
                                        className="text-sm font-medium hidden sm:inline">Pausar/Activar</span>
                                </button>
                                <button
                                    className="p-2 text-blue-700 hover:bg-blue-100 rounded-lg transition-colors flex items-center gap-2"
                                    title="Forzar Sincronización">
                                    <RefreshCw size={18} /> <span
                                        className="text-sm font-medium hidden sm:inline">Sincronizar</span>
                                </button>
                            </div>
                        </div>

                        <div className="flex items-center gap-2">
                            {/* Salida de Información */}
                            <button
                                className="p-2 text-gray-600 hover:bg-white hover:text-blue-600 rounded-lg transition-colors flex items-center gap-2"
                                title="Imprimir Etiquetas">
                                <Printer size={18} /> <span
                                    className="text-sm font-medium hidden md:inline">Imprimir</span>
                            </button>
                            <button
                                className="p-2 text-gray-600 hover:bg-white hover:text-blue-600 rounded-lg transition-colors flex items-center gap-2"
                                title="Exportar Selección">
                                <Download size={18} /> <span
                                    className="text-sm font-medium hidden md:inline">Exportar</span>
                            </button>

                            <div className="h-4 w-px bg-blue-200 mx-1"></div>
                            <button onClick={()=> setSelectedItems(new Set())}
                                className="ml-2 p-1 text-gray-400 hover:text-gray-600"
                                title="Cancelar Selección"
                                >
                                <X size={18} />
                            </button>
                        </div>
                    </div>
                    );
                    }
                    return null;
                    };

                    return (
                    <>
                        <div className="space-y-6 h-full flex flex-col animate-fade-in" onClick={()=> {
                            if(showExportMenu) setShowExportMenu(false);
                            if(showFilterMenu) setShowFilterMenu(false);
                            if(showColumnMenu) setShowColumnMenu(false);
                            }}>
                            {/* Encabezado */}
                            <div className="flex justify-between items-end flex-shrink-0 relative z-40">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800">Control de Stock</h2>
                                    <p className="text-sm text-gray-500">Gestión centralizada de productos e inventario.
                                    </p>
                                </div>

                                {/* Botón Importar/Exportar con Dropdown */}
                                <div className="relative">
                                    <button onClick={(e)=> { e.stopPropagation(); setShowExportMenu(!showExportMenu);
                                        setShowFilterMenu(false); setShowColumnMenu(false); }}
                                        className={`px-4 py-2 rounded-lg flex items-center gap-2 text-sm transition-all
                                        shadow-sm border ${showExportMenu ? 'bg-blue-700 text-white border-blue-700
                                        ring-2 ring-blue-100' : 'bg-blue-600 hover:bg-blue-700 text-white
                                        border-transparent'}`}
                                        >
                                        <Download size={16} />
                                        <span className="hidden sm:inline">Importar/Exportar</span>
                                        <ChevronDown size={14} className={`transition-transform duration-200
                                            ${showExportMenu ? 'rotate-180' : '' }`} />
                                    </button>

                                    {/* Menú Desplegable Personalizado */}
                                    {showExportMenu && (
                                    <div className="absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-xl border border-gray-100 py-2 z-50 animate-zoom-in origin-top-right"
                                        onClick={(e)=> e.stopPropagation()}>

                                        {/* --- GRUPO IMPORTAR --- */}
                                        <div className="px-4 py-3 bg-gray-100 border-b border-gray-200">
                                            <span
                                                className="text-xs font-bold text-gray-700 uppercase tracking-wider flex items-center gap-2">
                                                <FileUp size={14} className="text-blue-600" /> Importar (Entrada de
                                                datos)
                                            </span>
                                        </div>

                                        <button
                                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-blue-600 flex items-center gap-3 transition-colors group">
                                            <Package size={16} className="text-gray-400 group-hover:text-blue-600" />
                                            <span>Importar Productos</span>
                                        </button>
                                        <button
                                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-blue-600 flex items-center gap-3 transition-colors group">
                                            <RefreshCw size={16} className="text-gray-400 group-hover:text-blue-600" />
                                            <span>Actualización Masiva de Datos</span>
                                        </button>
                                        <button
                                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-blue-600 flex items-center gap-3 transition-colors group">
                                            <FileDown size={16} className="text-gray-400 group-hover:text-blue-600" />
                                            <span>Descargar Plantilla de Importación</span>
                                        </button>

                                        {/* --- GRUPO EXPORTAR --- */}
                                        <div className="px-4 py-3 bg-gray-100 border-y border-gray-200 mt-2">
                                            <span
                                                className="text-xs font-bold text-gray-700 uppercase tracking-wider flex items-center gap-2">
                                                <Download size={14} className="text-green-600" /> Exportar (Salida de
                                                datos)
                                            </span>
                                        </div>

                                        <button
                                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-green-600 flex items-center gap-3 transition-colors group">
                                            <FileSpreadsheet size={16}
                                                className="text-gray-400 group-hover:text-green-600" />
                                            <span>Exportar a Excel (.xlsx)</span>
                                        </button>
                                        <button
                                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-green-600 flex items-center gap-3 transition-colors group">
                                            <FileText size={16} className="text-gray-400 group-hover:text-green-600" />
                                            <span>Exportar a CSV</span>
                                        </button>
                                        <button
                                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-blue-600 flex items-center gap-3 transition-colors group">
                                            <Filter size={16} className="text-gray-400 group-hover:text-blue-600" />
                                            <span>Exportar Vista Actual</span>
                                        </button>
                                        <button
                                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-blue-600 flex items-center gap-3 transition-colors group">
                                            <Database size={16} className="text-gray-400 group-hover:text-blue-600" />
                                            <span>Exportar Todo el Inventario</span>
                                        </button>
                                        <button
                                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-red-500 flex items-center gap-3 transition-colors group">
                                            <Printer size={16} className="text-gray-400 group-hover:text-red-500" />
                                            <span>Exportar a PDF</span>
                                        </button>

                                    </div>
                                    )}
                                </div>
                            </div>

                            {/* Barra de Búsqueda y Filtros */}
                            <div
                                className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row gap-4 justify-between items-center flex-shrink-0 z-30">
                                <div className="relative w-full md:w-96">
                                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                                        size={18} />
                                    <input type="text" placeholder="Buscar por Nombre, SKU o Categoría..."
                                        className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm transition-shadow"
                                        value={search} onChange={(e)=> setSearch(e.target.value)}
                                    />
                                </div>
                                <div className="flex gap-2 w-full md:w-auto relative">
                                    <button onClick={(e)=> { e.stopPropagation(); setShowFilterMenu(!showFilterMenu);
                                        setShowExportMenu(false); setShowColumnMenu(false); }}
                                        className={`px-4 py-2 border rounded-lg flex items-center gap-2 text-sm flex-1
                                        md:flex-none justify-center transition-colors ${activeFilterCount > 0 ||
                                        showFilterMenu ? 'border-blue-500 bg-blue-50 text-blue-700 font-medium' :
                                        'border-gray-300 bg-white text-gray-700 hover:bg-gray-50'}`}
                                        >
                                        <Filter size={16} />
                                        Filtros
                                        {activeFilterCount > 0 && <span
                                            className="bg-blue-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full ml-1">{activeFilterCount}</span>}
                                    </button>

                                    {/* Dropdown de Filtros Avanzados */}
                                    {showFilterMenu && (
                                    <div className="absolute top-full right-0 mt-2 w-72 md:w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 p-4 animate-zoom-in"
                                        onClick={(e)=> e.stopPropagation()}>
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                                <ListFilter size={16} /> Filtrar Inventario
                                            </h3>
                                            {activeFilterCount > 0 && <button onClick={clearFilters}
                                                className="text-xs text-red-500 hover:text-red-700 font-medium">Borrar
                                                todo</button>}
                                        </div>

                                        <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-1">
                                            {/* Filtro: Categoría */}
                                            <div>
                                                <label
                                                    className="block text-xs font-bold text-gray-500 uppercase mb-1.5">Categoría</label>
                                                <select
                                                    className="w-full text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                                                    value={activeFilters.category} onChange={(e)=>
                                                    handleFilterChange('category', e.target.value)}
                                                    >
                                                    <option value="">Todas las categorías</option>
                                                    {categories.map(cat => <option key={cat} value={cat}>{cat}</option>
                                                    )}
                                                </select>
                                            </div>

                                            {/* Filtro: Estado */}
                                            <div>
                                                <label
                                                    className="block text-xs font-bold text-gray-500 uppercase mb-1.5">Estado</label>
                                                <select
                                                    className="w-full text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                                                    value={activeFilters.status} onChange={(e)=>
                                                    handleFilterChange('status', e.target.value)}
                                                    >
                                                    <option value="">Todos</option>
                                                    <option value="active">Activo (Con Stock)</option>
                                                    <option value="low_stock">Bajo Stock (Crítico)</option>
                                                    <option value="out_of_stock">Sin Stock (Agotado)</option>
                                                </select>
                                            </div>

                                            {/* Filtro: Enlazado */}
                                            <div>
                                                <label
                                                    className="block text-xs font-bold text-gray-500 uppercase mb-1.5">Integraciones</label>
                                                <select
                                                    className="w-full text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                                                    value={activeFilters.linked} onChange={(e)=>
                                                    handleFilterChange('linked', e.target.value)}
                                                    >
                                                    <option value="">Indiferente</option>
                                                    <option value="yes">Enlazado a Canales</option>
                                                    <option value="no">Sin Enlazar</option>
                                                </select>
                                            </div>

                                            {/* Filtro: Depósito */}
                                            <div>
                                                <label
                                                    className="block text-xs font-bold text-gray-500 uppercase mb-1.5">Depósito</label>
                                                <select
                                                    className="w-full text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                                                    value={activeFilters.warehouse} onChange={(e)=>
                                                    handleFilterChange('warehouse', e.target.value)}
                                                    >
                                                    <option value="">Todos los depósitos</option>
                                                    {uniqueLocations.map(loc => <option key={loc} value={loc}>{loc}
                                                    </option>)}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    )}

                                    <div className="relative">
                                        <button onClick={(e)=> { e.stopPropagation();
                                            setShowColumnMenu(!showColumnMenu); setShowFilterMenu(false);
                                            setShowExportMenu(false); }}
                                            className={`p-2 pl-3 pr-2 border rounded-lg flex items-center justify-center
                                            gap-1 transition-colors ${showColumnMenu ? 'border-blue-500 bg-blue-50
                                            text-blue-700' : 'border-gray-200 bg-white text-gray-600 hover:bg-gray-50
                                            hover:border-gray-300'}`}
                                            title="Configurar columnas"
                                            >
                                            <Columns size={18} />
                                            <ChevronDown size={14} className={`transition-transform duration-200
                                                ${showColumnMenu ? 'rotate-180' : '' }`} />
                                        </button>

                                        {/* Menú de Configuración de Columnas con Drag & Drop */}
                                        {showColumnMenu && (
                                        <div className="absolute top-full right-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-200 z-50 p-4 animate-zoom-in"
                                            onClick={(e)=> e.stopPropagation()}>
                                            <div
                                                className="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                                                <h3 className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                                    <Columns size={14} /> Configurar Vista
                                                </h3>
                                                <span
                                                    className="text-[10px] text-gray-400 uppercase tracking-wider">Visible</span>
                                            </div>

                                            <div className="space-y-1 max-h-[60vh] overflow-y-auto">
                                                {columns.map((col, idx) => (
                                                <div key={col.key} draggable onDragStart={(e)=> handleDragStart(e, idx)}
                                                    onDragOver={handleDragOver}
                                                    onDrop={(e) => handleDrop(e, idx)}
                                                    className={`flex items-center justify-between p-2 rounded-lg
                                                    cursor-pointer transition-colors ${col.visible ? 'hover:bg-blue-50'
                                                    : 'hover:bg-gray-50 text-gray-400'} ${dragItemIndex === idx ?
                                                    'opacity-50 border border-dashed border-blue-300 bg-blue-50' : ''}`}
                                                    onClick={() => toggleColumn(col.key)}
                                                    >
                                                    <div className="flex items-center gap-3">
                                                        <div
                                                            className="text-gray-300 cursor-grab active:cursor-grabbing hover:text-blue-500">
                                                            <GripVertical size={14} />
                                                        </div>
                                                        <span className={`text-sm ${col.visible
                                                            ? 'text-gray-700 font-medium' : 'text-gray-500' }`}>
                                                            {col.label}
                                                        </span>
                                                    </div>

                                                    {col.visible ? (
                                                    <Eye size={16} className="text-blue-600" />
                                                    ) : (
                                                    <EyeOff size={16} className="text-gray-300" />
                                                    )}
                                                </div>
                                                ))}
                                            </div>

                                            <div className="mt-3 pt-2 border-t border-gray-100">
                                                <button onClick={()=> setColumns(DEFAULT_COLUMN_CONFIG)}
                                                    className="text-xs text-center w-full text-blue-600 hover:underline"
                                                    >
                                                    Restaurar predeterminado
                                                </button>
                                            </div>
                                        </div>
                                        )}
                                    </div>

                                </div>
                            </div>

                            {/* TABLA PRINCIPAL */}
                            <div
                                className="bg-white rounded-xl shadow-sm border border-gray-200 flex-1 overflow-hidden flex flex-col relative">

                                {/* RENDER HEADER CONTEXTUAL */}
                                {renderTableHeader()}

                                <div className="overflow-auto flex-1">
                                    <table className="w-full text-left border-collapse">
                                        <thead
                                            className="bg-gray-50 text-xs text-gray-500 uppercase tracking-wider sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                {/* Checkbox Header */}
                                                <th className={`px-4 py-4 w-10 text-center ${selectedItems.size> 0 ?
                                                    'bg-blue-50 border-b border-blue-100' : 'bg-gray-50'}`}>
                                                    <input type="checkbox"
                                                        className="rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                                        checked={filtered.length> 0 && selectedItems.size ===
                                                    filtered.length}
                                                    onChange={() => toggleSelectAll(filtered)}
                                                    />
                                                </th>

                                                {columns.map((col) => {
                                                if (!col.visible) return null;

                                                if (col.sortable) {
                                                return (
                                                <SortableHeader key={col.key} label={col.label} sortKey={col.sortKey}
                                                    currentSort={activeFilters.sort} onSort={handleSort}
                                                    className={`${col.className || '' } ${col.align==='center'
                                                    ? 'text-center' : '' } ${col.width || '' }`} />
                                                );
                                                } else {
                                                return (
                                                <th key={col.key} className={`px-3 py-4 bg-gray-50 ${col.className || ''
                                                    } ${col.align==='center' ? 'text-center' : '' } ${col.width || ''
                                                    }`}>
                                                    {col.label}
                                                </th>
                                                );
                                                }
                                                })}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100 text-sm">
                                            {filtered.map(product => {
                                            const isSelected = selectedItems.has(product.id);
                                            return (
                                            <tr key={product.id} className={`transition-colors group ${isSelected
                                                ? 'bg-blue-50/60' : 'hover:bg-gray-50' }`}>
                                                {/* Checkbox Row */}
                                                <td className="px-4 py-3 text-center">
                                                    <input type="checkbox"
                                                        className="rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                                        checked={isSelected} onChange={()=>
                                                    toggleSelectItem(product.id)}
                                                    />
                                                </td>

                                                {columns.map(col => {
                                                if (!col.visible) return null;
                                                return (
                                                <td key={col.key} className={`px-3 py-3 ${col.className || '' }
                                                    ${col.align==='center' ? 'text-center' : '' }`}>
                                                    {renderCell(col, product)}
                                                </td>
                                                );
                                                })}
                                            </tr>
                                            );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                <div
                                    className="flex-shrink-0 border-t border-gray-100 p-4 bg-gray-50 flex justify-between items-center text-sm text-gray-500">
                                    <span>Mostrando {filtered.length} productos</span>
                                    <div className="flex gap-2">
                                        <button
                                            className="px-3 py-1 border rounded bg-white hover:bg-gray-50 disabled:opacity-50"
                                            disabled>Anterior</button>
                                        <button
                                            className="px-3 py-1 border rounded bg-white hover:bg-gray-50">Siguiente</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {selectedProduct && (
                        <ProductModal product={selectedProduct} onClose={()=> setSelectedProduct(null)}
                            onUpdate={onUpdateProduct}
                            categories={categories}
                            onAddCategory={onAddCategory}
                            />
                            )}
                    </>
                    );
                    };

                    // --- APP PRINCIPAL (SHELL) ---
                    const App = () => {
                    const [products, setProducts] = useState(INITIAL_PRODUCTS);
                    const [categories, setCategories] = useState(['Playa', 'Deportes', 'Hogar', 'Accesorios',
                    'Cuidado']);
                    const [activeView, setActiveView] = useState('control');
                    const [sidebarOpen, setSidebarOpen] = useState(true);
                    const [inventoryExpanded, setInventoryExpanded] = useState(true);

                    // Manejador para actualizar un producto desde el modal
                    // MODIFICADO: Ahora acepta originalId para saber a quién reemplazar
                    const handleUpdateProduct = (originalId, updatedProduct) => {
                    setProducts(prevProducts =>
                    prevProducts.map(p => p.id === originalId ? updatedProduct : p)
                    );
                    };

                    const handleAddCategory = (newCat) => {
                    if (!categories.includes(newCat)) {
                    setCategories([...categories, newCat]);
                    }
                    };

                    const NavItem = ({ id, label, icon: Icon, isSubItem = false }) => (
                    <button onClick={()=> setActiveView(id)}
                        className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors mb-1
                        ${
                        activeView === id
                        ? 'bg-blue-50 text-blue-700 font-medium'
                        : 'text-gray-600 hover:bg-gray-50'
                        } ${isSubItem ? 'pl-10' : ''}`}
                        >
                        <Icon size={isSubItem ? 16 : 20} className={activeView===id ? 'text-blue-600' : 'text-gray-400'
                            } />
                        {label}
                    </button>
                    );

                    return (
                    <div className="flex h-screen bg-gray-50 font-sans text-gray-900 overflow-hidden">
                        <CustomStyles />
                        {/* SIDEBAR */}
                        <aside className={`bg-white border-r border-gray-200 flex-shrink-0 transition-all duration-300
                            absolute md:relative z-50 h-full ${sidebarOpen ? 'w-64 translate-x-0'
                            : '-translate-x-full md:translate-x-0 md:w-20' } flex flex-col`}>
                            <div className="p-4 border-b border-gray-100 flex items-center justify-between h-16">
                                <div className={`flex items-center gap-2 ${!sidebarOpen && 'md:justify-center w-full'
                                    }`}>
                                    <div
                                        className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-blue-200">
                                        ERP</div>
                                    {sidebarOpen && <span
                                        className="font-bold text-lg tracking-tight text-gray-800">MiSistema</span>}
                                </div>
                                <button onClick={()=> setSidebarOpen(false)} className="md:hidden text-gray-500">
                                    <X size={20} />
                                </button>
                            </div>

                            <div className="p-4 flex-1 overflow-y-auto">
                                {/* Categoría Ventas */}
                                <div className="mb-2">
                                    <button
                                        className="w-full flex items-center justify-between px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <ShoppingCart size={20} className="text-gray-400" />
                                            {sidebarOpen && <span className="text-sm">Ventas</span>}
                                        </div>
                                    </button>
                                </div>

                                {/* Categoría Depósito */}
                                <div className="mb-2">
                                    <button
                                        className="w-full flex items-center justify-between px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <Truck size={20} className="text-gray-400" />
                                            {sidebarOpen && <span className="text-sm">Depósito</span>}
                                        </div>
                                    </button>
                                </div>

                                {/* Categoría INVENTARIO (Expandible) */}
                                <div className="mb-2">
                                    <button onClick={()=> setSidebarOpen(true) &&
                                        setInventoryExpanded(!inventoryExpanded)}
                                        className="w-full flex items-center justify-between px-3 py-2 text-gray-700
                                        hover:bg-gray-50 rounded-lg"
                                        >
                                        <div className="flex items-center gap-3">
                                            <Box size={20} className="text-blue-600" />
                                            {sidebarOpen && <span className="text-sm font-medium">Inventario</span>}
                                        </div>
                                        {sidebarOpen && (inventoryExpanded ?
                                        <ChevronDown size={16} /> :
                                        <ChevronRight size={16} />)}
                                    </button>

                                    {/* Sub Items de Inventario */}
                                    {(inventoryExpanded || !sidebarOpen) && (
                                    <div className={`mt-1 space-y-1 ${!sidebarOpen && 'hidden md:block' }`}>
                                        <NavItem id="dashboard" label="Tablero Principal" icon={LayoutDashboard}
                                            isSubItem={sidebarOpen} />
                                        <NavItem id="control" label="Control de Stock" icon={Package}
                                            isSubItem={sidebarOpen} />
                                        <NavItem id="history" label="Historial de Stock" icon={History}
                                            isSubItem={sidebarOpen} />
                                        <NavItem id="valuation" label="Valorización" icon={DollarSign}
                                            isSubItem={sidebarOpen} />
                                        <NavItem id="rotation" label="Análisis Rotación" icon={TrendingUp}
                                            isSubItem={sidebarOpen} />
                                    </div>
                                    )}
                                </div>
                            </div>

                            <div className="p-4 border-t border-gray-100 mt-auto">
                                <button
                                    className="flex items-center gap-3 text-sm text-gray-500 hover:text-gray-800 w-full px-2 py-2">
                                    <div
                                        className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600">
                                        A</div>
                                    {sidebarOpen && <div>
                                        <p className="font-medium">Admin User</p>
                                        <p className="text-xs">admin@empresa.com</p>
                                    </div>}
                                </button>
                            </div>
                        </aside>

                        {/* MAIN CONTENT */}
                        <main className="flex-1 flex flex-col h-full overflow-hidden bg-gray-50 relative">
                            <header
                                className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-8 flex-shrink-0">
                                <button onClick={()=> setSidebarOpen(!sidebarOpen)} className="text-gray-500
                                    hover:bg-gray-100 p-2 rounded-lg">
                                    <Menu size={20} />
                                </button>
                                <div className="flex items-center gap-4">
                                    <span className="text-xs text-gray-400 hidden sm:inline">v2.4.0 (Beta)</span>
                                    <div
                                        className="h-8 w-8 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-xs border border-blue-200">
                                        JD
                                    </div>
                                </div>
                            </header>

                            {/* Content Scrollable Area */}
                            <div className="flex-1 overflow-hidden p-4 md:p-8">
                                <div className="h-full max-w-7xl mx-auto">
                                    {activeView === 'dashboard' &&
                                    <DashboardView products={products} />}
                                    {activeView === 'control' &&
                                    <StockControlView products={products} onUpdateProduct={handleUpdateProduct}
                                        categories={categories} onAddCategory={handleAddCategory} />}
                                    {activeView === 'history' &&
                                    <HistoryView />}
                                    {activeView === 'valuation' &&
                                    <ValuationView products={products} />}
                                    {activeView === 'rotation' &&
                                    <RotationView />}
                                </div>
                            </div>
                        </main>

                        {/* Overlay para móvil */}
                        {sidebarOpen && (
                        <div className="fixed inset-0 bg-black/20 z-40 md:hidden animate-fade-in" onClick={()=>
                            setSidebarOpen(false)}
                            ></div>
                        )}
                    </div>
                    );
                    };

                    export default App;